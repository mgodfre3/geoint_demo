<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEOINT Tactical Globe ‚Äî Azure Local</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
        #cesiumContainer { width: 100%; height: 100%; }

        #overlay {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 16px 24px; display: flex; align-items: center; gap: 16px;
        }
        #overlay h1 { color: #fff; font-family: 'Segoe UI', system-ui; font-size: 20px; font-weight: 600; }
        .badge {
            background: #0078d4; color: #fff; padding: 4px 12px;
            border-radius: 12px; font-size: 12px; font-weight: 500;
            font-family: 'Segoe UI', system-ui;
        }

        #alerts {
            position: fixed; bottom: 16px; right: 16px; z-index: 1000;
            max-width: 350px; font-family: 'Segoe UI', system-ui;
        }
        .alert-item {
            background: rgba(255, 82, 82, 0.9); color: #fff;
            padding: 12px 16px; margin-top: 8px; border-radius: 8px;
            font-size: 13px; animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(4px);
        }
        .alert-item.detection { background: rgba(255, 193, 7, 0.9); color: #000; }
        .alert-item.status_change { background: rgba(0, 120, 212, 0.9); }

        #entity-count {
            position: fixed; bottom: 16px; left: 16px; z-index: 1000;
            background: rgba(0,0,0,0.7); color: #0f0; padding: 12px 16px;
            border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px;
            border: 1px solid #0f03;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="overlay">
        <a href="../../../scripts/kiosk-launcher.html" style="color:#0078d4;font-size:12px;text-decoration:none;font-family:'Segoe UI',system-ui;opacity:0.8;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">‚Üê Launcher</a>
        <h1>üåê GEOINT Tactical Operating Picture</h1>
        <span class="badge">Azure Local</span>
        <span class="badge" style="background: #00c853;">‚óè LIVE</span>
        <span class="badge" id="kiosk-badge" style="background: #ffc107; color: #000;">KIOSK MODE</span>
        <span style="margin-left:auto;font-family:'Segoe UI',system-ui;font-size:11px;color:#666;">Powered by Azure Local</span>
    </div>

    <div id="cesiumContainer"></div>

    <div id="entity-count">
        <div>TRACKED ENTITIES: <span id="count">0</span></div>
        <div>ALERTS: <span id="alert-count">0</span></div>
        <div>UPTIME: <span id="uptime">00:00:00</span></div>
    </div>

    <div id="alerts"></div>

    <script>
        // Replace with your Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'YOUR_CESIUM_ION_TOKEN';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            baseLayer: Cesium.ImageryLayer.fromProviderAsync(
                Cesium.IonImageryProvider.fromAssetId(2)
            ),
            animation: false,
            timeline: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            baseLayerPicker: false,
            navigationHelpButton: false,
            fullscreenButton: false,
            infoBox: true,
            selectionIndicator: true,
        });

        // Entity tracking
        const trackedEntities = {};
        let alertCount = 0;
        const startTime = Date.now();

        // WebSocket connection for real-time data
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${location.host}`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'entity_update') {
                updateEntities(data.entities);
            } else if (data.type === 'alert') {
                showAlert(data);
            } else if (data.type === 'detection_update') {
                showDetections(data.detections);
            }
        };

        ws.onclose = () => setTimeout(() => location.reload(), 3000);

        // Handle AI detection results from Demo 1
        const detectionEntities = [];
        function showDetections(data) {
            // Remove previous detection markers
            detectionEntities.forEach(e => viewer.entities.remove(e));
            detectionEntities.length = 0;

            const features = (data && data.features) ? data.features : (Array.isArray(data) ? data : []);
            features.forEach(f => {
                let lon, lat, label, confidence;
                if (f.geometry && f.geometry.coordinates) {
                    // GeoJSON polygon ‚Äî use centroid of first ring
                    const ring = f.geometry.coordinates[0];
                    lon = ring.reduce((s, c) => s + c[0], 0) / ring.length;
                    lat = ring.reduce((s, c) => s + c[1], 0) / ring.length;
                } else {
                    lon = f.lon || -77.04;
                    lat = f.lat || 38.89;
                }
                label = (f.properties && f.properties.label) || f.label || 'detection';
                confidence = (f.properties && f.properties.confidence) || f.confidence || 0;

                const ent = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat, 50),
                    point: { pixelSize: 14, color: Cesium.Color.RED, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                    label: {
                        text: `${label} ${(confidence * 100).toFixed(0)}%`,
                        font: '11px monospace',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -12),
                    },
                });
                detectionEntities.push(ent);
            });
        }

        function updateEntities(entities) {
            let count = 0;
            Object.entries(entities).forEach(([category, items]) => {
                items.forEach(entity => {
                    count++;
                    const id = entity.id;
                    const position = Cesium.Cartesian3.fromDegrees(
                        entity.lon, entity.lat, entity.alt || 0
                    );

                    if (!trackedEntities[id]) {
                        const color = category === 'aircraft' ? Cesium.Color.CYAN :
                                     category === 'vessels' ? Cesium.Color.YELLOW :
                                     Cesium.Color.LIME;

                        trackedEntities[id] = viewer.entities.add({
                            id: id,
                            name: `${entity.type} (${id})`,
                            position: position,
                            point: { pixelSize: 10, color: color, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                            label: {
                                text: `${entity.type}\n${id}`,
                                font: '12px monospace',
                                fillColor: color,
                                outlineColor: Cesium.Color.BLACK,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                pixelOffset: new Cesium.Cartesian2(0, -15),
                            },
                        });
                    } else {
                        trackedEntities[id].position = position;
                    }
                });
            });

            document.getElementById('count').textContent = count;
        }

        function showAlert(data) {
            alertCount++;
            document.getElementById('alert-count').textContent = alertCount;

            const alertsDiv = document.getElementById('alerts');
            const alertEl = document.createElement('div');
            alertEl.className = `alert-item ${data.alertType}`;
            alertEl.textContent = `[${data.alertType.toUpperCase()}] ${data.message}`;
            alertsDiv.appendChild(alertEl);

            // Flash entity on globe at alert location
            if (data.location) {
                const alertEntity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(data.location.lon, data.location.lat),
                    point: { pixelSize: 20, color: Cesium.Color.RED.withAlpha(0.8) },
                });
                setTimeout(() => viewer.entities.remove(alertEntity), 5000);
            }

            // Remove old alerts
            setTimeout(() => alertEl.remove(), 10000);
            while (alertsDiv.children.length > 5) {
                alertsDiv.removeChild(alertsDiv.firstChild);
            }
        }

        // Uptime counter
        setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const s = String(elapsed % 60).padStart(2, '0');
            document.getElementById('uptime').textContent = `${h}:${m}:${s}`;
        }, 1000);

        // Kiosk mode: auto-rotate camera around DC
        let kioskActive = true;
        const kioskWaypoints = [
            { lon: -77.0369, lat: 38.8951, height: 5000, heading: -17, pitch: -35 },
            { lon: -77.0509, lat: 38.8719, height: 3000, heading: 45, pitch: -25 },
            { lon: -77.0091, lat: 38.8899, height: 2000, heading: -90, pitch: -30 },
            { lon: -77.1482, lat: 38.7509, height: 8000, heading: 0, pitch: -40 },
        ];
        let currentWaypoint = 0;

        function flyToNextWaypoint() {
            if (!kioskActive) return;
            const wp = kioskWaypoints[currentWaypoint];
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.height),
                orientation: {
                    heading: Cesium.Math.toRadians(wp.heading),
                    pitch: Cesium.Math.toRadians(wp.pitch),
                    roll: 0,
                },
                duration: 8,
                complete: () => {
                    currentWaypoint = (currentWaypoint + 1) % kioskWaypoints.length;
                    setTimeout(flyToNextWaypoint, 12000);
                },
            });
        }

        // Start kiosk flyover after initial load
        setTimeout(flyToNextWaypoint, 3000);

        // Disable kiosk on user interaction, re-enable after 30s
        viewer.scene.canvas.addEventListener('mousedown', () => {
            kioskActive = false;
            document.getElementById('kiosk-badge').style.background = '#666';
            document.getElementById('kiosk-badge').textContent = 'INTERACTIVE';
            clearTimeout(window._kioskTimer);
            window._kioskTimer = setTimeout(() => {
                kioskActive = true;
                document.getElementById('kiosk-badge').style.background = '#ffc107';
                document.getElementById('kiosk-badge').textContent = 'KIOSK MODE';
                flyToNextWaypoint();
            }, 30000);
        });
    </script>
</body>
</html>
